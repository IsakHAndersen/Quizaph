@layout MainLayout
@page "/Quiz"
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject CurrentQuizStateService QuizState
@inject IJSRuntime JS
@inject HttpService HttpService
@using QuizaphFrontend.Components.ChildComponents
@using QuizaphFrontend.Services
@using global::Models.Enums
@using QuizaphFrontend.Components.MudblazorDialogComponents

<MudPaper Square="true" MaxWidth="MaxWidth.Large"
          Style="padding: 0px 120px 0px 120px; background: #F5F8FC url('/SVGS/squaresPattern.svg') repeat;  min-height: 100vh;"
          Elevation="0">
    <MudStack Spacing="7" Class="pt-12">

        <!-- Header + Image + Buttons -->
        <MudItem>
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.h5" Style="font-family: 'Roboto Condensed'">
                    @QuizState.CurrentQuizInfo?.Title
                </MudText>
                <MudStack Row="true" Spacing="6" AlignItems="AlignItems.Center" style="border-radius: 10px; background: white; padding: 12px 18px;">

                    @if (QuizState.CurrentQuizInfo is not null)
                    {
                        var modes = Enum.GetValues(typeof(QuizMode))
                        .Cast<QuizMode>()
                        .Where(m => QuizState.CurrentQuizInfo.QuizModes.HasFlag(m) && m != QuizMode.None);

                        if (modes.Count() > 1)
                        {
                            <MudMenu Label=@HelperMethods.SplitByCamelCase(selectedMode.ToString()) Variant="Variant.Filled" Color="Color.Tertiary" Size="Size.Medium" Dense>
                                @foreach (var mode in modes)
                                {
                                    <MudMenuItem Label="@HelperMethods.SplitByCamelCase(mode.ToString())" OnClick="@(() => SelectMode(mode))" />
                                }
                            </MudMenu>
                        }
                    }


                    @if (availableDatasets?.Any() == true)
                    {
                        <MudSelect T="QuizDataset"
                                   Value="@selectedDataset"
                                   ValueChanged="SelectDataset"
                                   Label="Select dataset"
                                   Dense="true"
                                   Style="min-width:200px">
                            @foreach (var ds in availableDatasets)
                            {
                                <MudSelectItem T="QuizDataset" Value="@ds">@ds.Name</MudSelectItem>
                            }
                        </MudSelect>
                    }

                    <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small"
                               OnClick="Reset" StartIcon="@Icons.Material.Filled.RestartAlt"
                               Style="text-transform: none;">
                        Restart
                    </MudButton>

                    <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small"
                               OnClick="ShowEndScreen" StartIcon="@Icons.Material.Filled.Output"
                               Style="text-transform: none;">
                        End Quiz
                    </MudButton>
                    @if (QuizState.CurrentQuizInfo?.QuizRules?.Any() == true)
                    {
                        <MudButton @onclick="() => OpenDialogAsync(DialogType.Rules)"
                                   Variant="Variant.Text" Color="Color.Dark"
                                   EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                                   Style="text-transform: none;" Size="Size.Small">
                            Rules
                        </MudButton>
                    }
                    @if (!string.IsNullOrWhiteSpace(QuizState.CurrentQuizInfo?.Description))
                    {
                        <MudButton @onclick="() => OpenDialogAsync(DialogType.Information)"
                                   Variant="Variant.Text" Color="Color.Dark"
                                   EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                                   Style="text-transform: none;" Size="Size.Small">
                            Info
                        </MudButton>
                    }
                </MudStack>
                @if (!string.IsNullOrWhiteSpace(QuizState.CurrentQuizInfo?.ImagePath))
                {
                    <MudImage Src="@QuizState.CurrentQuizInfo.ImagePath"
                              Elevation="25"
                              Class="rounded-lg"
                              Style="border-radius: 20px; width: 50px; height: 50px;" />
                }
            </MudStack>
        </MudItem>

        <!-- Main quiz content -->
        @if (QuizState.CurrentQuizInfo != null)
        {
            <MudPaper Square="true" Style="position: relative; padding: 0; background-color: transparent; border-radius: 5px;" Elevation="0">
                @switch (QuizState.CurrentQuizInfo.QuizType)
                {
                    case QuizType.WorldCountriesQuiz:
                        <CascadingValue Value="QuizState.CurrentQuizInfo">
                            <CountriesOfTheWorldComponent />
                        </CascadingValue>
                        break;
                    case QuizType.TriviaQuiz:
                        <CascadingValue Value="QuizState.CurrentQuizInfo">
                            <TriviaQuizComponent />
                        </CascadingValue>
                        break;
                    default:
                        <MudText>No quiz available.</MudText>
                        break;
                }
            </MudPaper>
        }
    </MudStack>
</MudPaper>

@code {

    private QuizMode selectedMode = QuizMode.Standard;
    private List<QuizDataset>? availableDatasets;
    private QuizDataset? selectedDataset;
    protected override async Task OnInitializedAsync()
    {
        var rules = await HttpService.GetQuizRules(QuizState.CurrentQuizInfo.Id);
        var availableDatasets = await HttpService.GetQuizDataSets(QuizState.CurrentQuizInfo.Id);
        if (availableDatasets != null)
        {
            this.availableDatasets = availableDatasets;
        }
        QuizState.CurrentQuizInfo.QuizRules = rules;
    }

    private async Task OpenDialogAsync(DialogType type)
    {
        var dialogData = new Dialog
        {
            Title = type.ToString(),
            DialogContent = type switch
            {
                DialogType.Rules => QuizState.CurrentQuizInfo?.QuizRules?.Select(r => r.Rule).ToList()?? new List<string>(){ "No rules."},
                DialogType.Information => !string.IsNullOrWhiteSpace(QuizState.CurrentQuizInfo?.Description)
                                          ? new List<string> { QuizState.CurrentQuizInfo.Description }
                                          : new List<string>(),
                DialogType.Ranking => new List<string> { "Not Implemented" },
                _ => new List<string>()
            }
        };
        var parameters = new DialogParameters
        {
            { "Dialog", dialogData }
        };

        // Set options
        var options = new DialogOptions { CloseOnEscapeKey = true };

        await DialogService.ShowAsync<BasicDialog>(dialogData.Title, parameters, options);
    }
    async Task SelectDataset(QuizDataset quizDataset)
    {
        selectedDataset = quizDataset;
        await QuizState.InvokeDatasetChanged(quizDataset);
    }

    async Task SelectMode(QuizMode mode)
    {
        selectedMode = mode;
        await QuizState.InvokeModeChanged(mode);
    }
    async Task Reset()
    {
        await QuizState.InvokeRequestReset();
    }
    async Task ShowEndScreen()
    {
        bool? result = await DialogService.ShowMessageBox(
        "End Quiz?",
        "Are you sure you want to end the quiz?",
        yesText: "Confirm",
        cancelText: "Cancel",
        options: new DialogOptions { MaxWidth = MaxWidth.Small });

        if (result == true)
        {
            await QuizState.InvokeShowEndScreen();
        }
    }
}
