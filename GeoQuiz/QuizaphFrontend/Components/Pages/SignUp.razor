@page "/SignUp"
@using CommonModels.UserModels
@using QuizaphFrontend.Services
@using System.ComponentModel.DataAnnotations
@layout EmptyLayout
@inject NavigationManager Navigation
@inject BackendClient BackendClient
@inject IJSRuntime JS
@inject IConfiguration Configuration
@inject HttpClient Http


<MudPaper Square="true" style="background-color: transparent;" Elevation="0">
    <MudIconButton Icon=@Icons.Material.Filled.Home Color="Color.Primary" Variant="Variant.Filled"
                   Style="text-transform: none; margin-left: 20px; margin-bottom: 10px;" OnClick="@NavigateToMainPage">
    </MudIconButton>
    <MudContainer MaxWidth="MaxWidth.ExtraSmall">
        <MudPaper MaxHeight="40%" Width="100%" Square="true"
                  style="border-radius: 20px; padding: 30px 40px 30px 40px;">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h5" Style="font-weight: 500; align-self: center; margin-bottom: 10px;">
                    Welcome To Quizaph
                </MudText>

                <!-- NEW: Proper Blazor + MudBlazor registration form (AJAX) -->
                <EditForm Model="@model" OnValidSubmit="@HandleRegister">
                    <DataAnnotationsValidator />
                    <ValidationSummary/>

                    <MudTextField @bind-Value="model.Username"
                                  Label="Username"
                                  Required="true"
                                  Class="mb-3" />

                    <MudTextField @bind-Value="model.Email"
                                  Label="Email"
                                  InputType="InputType.Email"
                                  Required="true"
                                  Class="mb-3" />

                    <MudTextField @bind-Value="model.Password"
                                  Label="Password"
                                  InputType="InputType.Password"
                                  Required="true"
                                  Class="mb-3" />

                    <MudTextField @bind-Value="model.ConfirmPassword"
                                  Label="Confirm Password"
                                  InputType="InputType.Password"
                                  Required="true"
                                  For="@(() => model.ConfirmPassword)"
                                  Class="mb-4" />

                    <MudStack AlignItems="AlignItems.Center">
                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Disabled="@loading"
                                   Style="width:120px;">
                                   Sign Up
                        </MudButton>

                        @if (!string.IsNullOrEmpty(AlertMessage))
                        {
                            <MudAlert Severity="Severity.Error" Class="ml-3">@AlertMessage</MudAlert>
                        }
                    </MudStack>
                </EditForm>

                <MudDivider DividerType="DividerType.Middle" Class="my-6" />

                <!-- Google button stays exactly as you had it -->
                <MudStack Spacing="3" Row="true" AlignItems="AlignItems.Center" Style="align-self:center;">
                    <MudButton OnClick="@GoogleLogin"
                               Variant="Variant.Text"
                               Color="Color.Default"
                               Style="text-transform: none; font-weight: 500; border-radius: 4px; padding: 0 12px; height: 40px;">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" style="width: 18px; height: 18px;" />
                            <span>Sign up with Google</span>
                        </MudStack>
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudContainer>
</MudPaper>

@code {
    #region Alert
    bool ShowAlertFlag = false;
    Severity AlertSeverity = Severity.Normal;
    string AlertMessage = "";
    string BackendUrl => Configuration["BackendBaseUrl"]!;

    private async Task ShowAlert(Severity severity, string message)
    {
        AlertSeverity = severity;
        AlertMessage = message;
        ShowAlertFlag = true;
        await Task.Delay(3000);
        ShowAlertFlag = false;
        StateHasChanged();
    }
    #endregion

    private RegisterModel model = new();
    private bool loading = false;
    InputType PasswordInput = InputType.Password;


    private void NavigateToMainPage() => Navigation.NavigateTo("/");
    private void SignIn() => Navigation.NavigateTo("/Login");

    private async Task HandleRegister()
    {
        loading = true;
        AlertMessage = null;

        try
        {
            var response = await Http.PostAsJsonAsync($"{BackendUrl}/api/users/register", model);

            if (response.IsSuccessStatusCode)
            {
                // Cookie is set → full reload so Blazor sees the logged-in user
                Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
                return;
            }

            var error = await response.Content.ReadAsStringAsync();
            AlertMessage = error.Contains("Username", StringComparison.OrdinalIgnoreCase) ? "Username already taken" :
                           error.Contains("Email", StringComparison.OrdinalIgnoreCase) ? "Email already registered" :
                           "Unable to register. Please check your details and try again.";
        }
        catch (Exception ex)
        {
            AlertMessage = "Network error. Please try again.";
        }
        finally
        {
            loading = false;
        }
    }

    private void GoogleLogin()
    {
        Navigation.NavigateTo("auth/google-login", forceLoad: true);
    }


    public class RegisterModel
    {
        [Required] public string Username { get; set; } = "";
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required, StringLength(100, MinimumLength = 6)] public string Password { get; set; } = "";
        [Required, Compare(nameof(Password))] public string ConfirmPassword { get; set; } = "";
    }
}
