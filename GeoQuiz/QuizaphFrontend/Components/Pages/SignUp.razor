@page "/SignUp"
@using CommonModels.UserModels
@using QuizaphFrontend.Services
@using System.ComponentModel.DataAnnotations
@layout EmptyLayout
@inject NavigationManager Navigation
@inject BackendClient BackendClient
@inject IJSRuntime JS
@inject IConfiguration Configuration

<MudPaper Square="true" style="background-color: transparent;" Elevation="0">
    <MudIconButton Icon=@Icons.Material.Filled.Home Color="Color.Primary" Variant="Variant.Filled"
                   Style="text-transform: none; margin-left: 20px; margin-bottom: 10px;" OnClick="@NavigateToMainPage">
    </MudIconButton>
    <MudContainer MaxWidth="MaxWidth.ExtraSmall">
        <MudPaper MaxHeight="40%" Width="100%" Square="true"
                  style="background-color: #ffffff; border-radius: 20px; padding: 30px 40px 30px 40px;">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h5" Style="font-weight: 500; align-self: center; margin-bottom: 10px;">
                    Welcome To Quizaph
                </MudText>

                <!-- Username/Email/Password Fields -->
                <form action="@($"{BackendUrl}/api/users/register")" method="post">
                        <input type="text" name="username" placeholder="Username" style="width:100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc;" />

                        <input type="email" name="email" placeholder="Email" style="width:100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc;" />

                        <input type="password" name="password" placeholder="Password" style="width:100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc;" />

                        <input type="password" name="confirmPassword" placeholder="Confirm Password" style="width:100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc;" />

                        <button type="submit"
                                class="mud-button-root mud-button mud-button-filled mud-button-filled-primary"
                                style="width:120px; margin-top: 10px;">
                            Sign up
                        </button>
                </form>

                <MudDivider DividerType="DividerType.Middle" Class="my-2" />

                <!-- Google Sign-In Button -->
                <MudStack Spacing="3" Row="true" AlignItems="AlignItems.Center" Style="align-self:center;">
                    <MudButton OnClick="@GoogleLogin"
                               Variant="Variant.Outlined"
                               Color="Color.Default"
                               Style="background-color: white;
                      border: 0px solid;
                      text-transform: none;
                      color: #3c4043;
                      font-weight: 500;
                      border-radius: 4px;
                      padding: 0 12px;
                      height: 40px;">

                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <!-- Google "G" logo -->
                            <img src="https://developers.google.com/identity/images/g-logo.png"
                                 alt="Google"
                                 style="width: 18px; height: 18px;" />

                            <!-- Button text -->
                            <span>Sign up with Google</span>
                        </MudStack>
                    </MudButton>
                </MudStack>

                <MudDivider DividerType="DividerType.Middle" Class="my-1" />

                <!-- Remember Me -->
                <MudStack Spacing="2" Row="true" AlignItems="AlignItems.Center" Style="margin-left: 5px;">
                    <MudText>Remember me?</MudText>
                    <MudCheckBox @bind-Value="registerForm.RememberMe" Color="Color.Primary"
                                 UncheckedColor="Color.Default" Dense />
                </MudStack>

                <!-- Already a user? -->
                <MudStack Spacing="2" Row="true" AlignItems="AlignItems.Center" Style="align-self:center;">
                    <MudButton Style="align-self: center; color: black; text-transform: none;" OnClick="@SignIn"
                               Variant="Variant.Text">
                        Already a user? Sign In
                    </MudButton>
                </MudStack>

                @if (ShowAlertFlag)
                {
                    <MudAlert Severity="@AlertSeverity" Elevation="0" Dense="true">
                        @AlertMessage
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    </MudContainer>
</MudPaper>

@code {
    #region Alert
    bool ShowAlertFlag = false;
    Severity AlertSeverity = Severity.Normal;
    string AlertMessage = "";
    string BackendUrl => Configuration["BackendBaseUrl"]!;

    private async Task ShowAlert(Severity severity, string message)
    {
        AlertSeverity = severity;
        AlertMessage = message;
        ShowAlertFlag = true;
        await Task.Delay(3000);
        ShowAlertFlag = false;
        StateHasChanged();
    }
    #endregion

    private RegisterForm registerForm { get; set; } = new RegisterForm();
    InputType PasswordInput = InputType.Password;


    public class RegisterForm
    {   
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public bool RememberMe { get; set; } = false;
    }

    private void NavigateToMainPage() => Navigation.NavigateTo("/");
    private void SignIn() => Navigation.NavigateTo("/Login");

    private void GoogleLogin()
    {
        Navigation.NavigateTo("auth/google-login", forceLoad: true);
    }

    private bool IsValidLoginRequest()
    {
        if (!IsValidPassword(registerForm.Password)) return false;
        if (!IsValidEmail(registerForm.Email)) return false;
        if (registerForm.Password != registerForm.ConfirmPassword) return false;
        return true;
    }

    private bool IsValidEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            _ = ShowAlert(Severity.Error, "Email is required.");
            return false;
        }

        try
        {
            var _ = new System.Net.Mail.MailAddress(email);
            return true;
        }
        catch
        {
            _ = ShowAlert(Severity.Error, "Invalid email format.");
            return false;
        }
    }

    private bool IsValidPassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
        {
            _ = ShowAlert(Severity.Error, "Password cannot be empty.");
            return false;
        }

        if (password.Length < 8)
        {
            _ = ShowAlert(Severity.Error, "Password cannot be less than 8 characters.");
            return false;
        }

        if (!System.Text.RegularExpressions.Regex.IsMatch(password, @"^[a-zA-Z0-9]+$"))
        {
            _ = ShowAlert(Severity.Error, "Password cannot contain special characters.");
            return false;
        }

        return true;
    }
}
