@using Microsoft.AspNetCore.Components.Authorization
@using QuizaphFrontend.Services
@inject NavigationManager navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject BackendClient HttpService
@inject IJSRuntime JS

<MudAppBar Fixed="true" Elevation="0" Color="Color.Surface" Class="appbar-height">
    <MudContainer MaxWidth="MaxWidth.Large" Class="d-flex justify-space-between align-center" Style="height:100%; padding:0 16px;">

        <!-- Left side -->
        <div class="d-flex align-center">
            <img src="QuizImages/appbaricon.png" alt="Quizaph Logo" width="36" height="36" class="mr-2" />

            <MudText Class="quizaph-gradient" Style="font-size:24px; font-weight:500; font-family:'Roboto Condensed'; margin-right:20px;">
                Quizaph
            </MudText>

            <!-- Desktop "Tabs" -->
            <MudHidden Breakpoint="Breakpoint.SmAndDown">
                <div class="d-flex ml-4">
                    @foreach (var tab in tabs)
                    {
                        <MudButton Variant="Variant.Text"
                                   StartIcon="@tab.Icon"
                                   Class="@(currentRoute == tab.Route ? "nav-tab nav-tab-active" : "nav-tab")"
                                   OnClick="@(() => Navigate(tab.Route))"
                                   Style="margin-left:8px; margin-right:8px; border-radius:0px; font-weight:400;">
                            @tab.Label
                        </MudButton>
                    }
                    @if (isPrivilegedUser)
                    {
                        <MudButton Variant="Variant.Text"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Class="@(currentRoute == "/create-quiz" ? "nav-tab nav-tab-active" : "nav-tab")"
                                   OnClick="@(() => Navigate("/Create-quiz"))"
                                   Style="margin-left:8px; margin-right:8px; border-radius:0px; font-weight:400;">
                            Create Quiz
                        </MudButton>
                    }
                </div>
            </MudHidden>

            <!-- Mobile menu -->
            <MudHidden Breakpoint="Breakpoint.MdAndUp">
                <MudMenu Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" AnchorOrigin="Origin.TopLeft" TransformOrigin="Origin.TopLeft">
                    @foreach (var tab in tabs)
                    {
                        <MudMenuItem Icon="@tab.Icon" OnClick="@(() => Navigate(tab.Route))">
                            @tab.Label
                        </MudMenuItem>
                    }
                    @if (isPrivilegedUser)
                    {
                        <MudMenuItem Icon="@Icons.Material.Filled.Add" OnClick="@(() => Navigate("/Create-quiz"))">
                            Create Quiz
                        </MudMenuItem>
                    }
                </MudMenu>
            </MudHidden>
        </div>

        <!-- Right side -->
        <div class="d-flex align-center">
            <MudIconButton Icon="@((isDarkMode) ? Icons.Material.Filled.WbSunny : Icons.Material.Filled.NightsStay)"
                           OnClick="ToggleDarkMode"
                           Size="Size.Small"
                           Style="@GetIconColor()" />

            @if (!isLoggedIn)
            {
                <MudHidden Breakpoint="Breakpoint.SmAndDown">
                    <MudButton Variant="Variant.Text" OnClick="@SignIn" Style="text-transform:none; font-weight:400;" Size="Size.Large">Login</MudButton>
                    <MudButton OnClick="@SignUp" Variant="Variant.Filled" Size="Size.Large"
                               Style="border-radius:20px; text-transform:none; white-space:nowrap; min-width:90px;">
                        Sign Up
                    </MudButton>
                </MudHidden>
            }
            else
            {
                <MudMenu Label="Profile" Variant="Variant.Text"
                         EndIcon="@Icons.Material.Filled.KeyboardArrowDown"
                         StartIcon="@Icons.Material.Filled.Person"
                         Color="Color.Inherit" Dense Class="profile-menu">
                    <MudMenuItem Icon="@Icons.Material.Filled.Person" Label="Edit Profile" />
                    <MudMenuItem Icon="@Icons.Material.Filled.BarChart" Label="Quiz Stats" />
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout" Label="Logout" OnClick="Logout" />
                </MudMenu>
            }

            @if (isLoggedIn)
            {
                <AuthorizeView>
                    <Authorized>
                        <div class="d-flex align-center ml-4">
                            <MudText Typo="Typo.body2" Style="font-weight:500; margin-right:12px;">
                                @context.User.Identity!.Name
                            </MudText>
                            <MudAvatar Size="Size.Medium" Class="elevation-1">
                                @if (context.User.Claims.FirstOrDefault(c => c.Type == "picture")?.Value is string picture && !string.IsNullOrWhiteSpace(picture))
                                {
                                    <MudImage Src="@picture" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                                }
                            </MudAvatar>
                        </div>
                    </Authorized>
                </AuthorizeView>
            }
        </div>
    </MudContainer>
</MudAppBar>

<style>
    .quizaph-gradient {
        background: linear-gradient(90deg, #4A6CF7, #455ADE, #60A5FA);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
    }

    .profile-menu .mud-button-label {
        font-weight: 350;
    }

    .nav-tab {
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: none;
        font-size: 14px;
        min-width: 80px;
        border-bottom: 2px solid transparent;
        padding: 6px 12px;
    }

    .nav-tab-active {
        font-weight: 600;
        border-bottom: 2px solid var(--mud-palette-primary);
    }

    .appbar-height {
        height: 70px;
    }
</style>


@code {
    private bool isDarkMode = false;
    [Parameter]
    public EventCallback<bool> OnDarkModeToggled { get; set; }
    private string currentRoute;
    private bool isPrivilegedUser = false;
    bool isLoggedIn = false;

    private List<(string Label, string Route, string Icon)> tabs = new()
    {
        ("Home", "/", Icons.Material.Filled.Home),
        ("Quizzes", "/Quizzes", Icons.Material.Filled.Apps),
    };

    protected override async Task OnInitializedAsync()
    {
        currentRoute = navigation.Uri.Replace(navigation.BaseUri, "/");
        await UpdateUserStateAsync();

        AuthStateProvider.AuthenticationStateChanged += async (task) =>
        {
            var authState = await task;
            var user = authState.User;
            isLoggedIn = user.Identity?.IsAuthenticated ?? false;
            await InvokeAsync(StateHasChanged);
        };
    }

    private async Task UpdateUserStateAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isLoggedIn = user.Identity?.IsAuthenticated ?? false;

        if (isLoggedIn)
        {
            isPrivilegedUser = user.IsInRole("Admin") || user.IsInRole("User");
        }
        else
        {
            isPrivilegedUser = false;
        }
    }

    private void Navigate(string route)
    {
        currentRoute = route;
        navigation.NavigateTo(route);
    }

    private async Task Logout()
    {
        navigation.NavigateTo("auth/logout", forceLoad: true);
    }

    private async Task ToggleDarkMode()
    {
        isDarkMode = !isDarkMode;
        await OnDarkModeToggled.InvokeAsync(isDarkMode);
        await JS.InvokeVoidAsync("localStorage.setItem", "darkMode", isDarkMode);
    }

    private void SignIn()
    {
        navigation.NavigateTo("Login");
    }

    private void SignUp()
    {
        navigation.NavigateTo("SignUp");
    }

    private string GetIconColor()
    {
        return isDarkMode ? "color: orange;" : "color: #1E3A8A;";
    }
}
